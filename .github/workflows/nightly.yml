---
name: nightly

on:
  schedule:
  - cron: 0 9 * * *
  workflow_dispatch: {}

jobs:
  # Determine the base commit of the selected commit. The output is passed to
  # the `base` job below. If the data already exists for this commit, it will be
  # skipped.
  determine_head:
    runs-on: ubuntu-latest
    outputs:
      commit: ${{ steps.head.outputs.commit }}
    steps:
    - name: Checkout benchmarking repo
      uses: actions/checkout@v4
      with:
        persist-credentials: false
    - name: Read pinned commit
      id: head
      run: |
        if [ -f commit.txt ]; then
          COMMIT=$(cat commit.txt | tr -d '[:space:]')
          echo "Using pinned commit: $COMMIT"
          echo "commit=$COMMIT" >> $GITHUB_OUTPUT
        else
          echo "commit.txt not found, falling back to latest CPython main"
          git clone --depth 1 https://github.com/python/cpython.git cpython
          cd cpython
          git log -n 1 --format="commit=%H" >> $GITHUB_OUTPUT
        fi

  pystats:
    uses: ./.github/workflows/_pystats.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      benchmarks: all
      tier2: false
    secrets: inherit

  pystats-tier2:
    uses: ./.github/workflows/_pystats.yml
    needs: [determine_head, pystats]
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      benchmarks: all
      tier2: true
    secrets: inherit

  generate:
    uses: ./.github/workflows/_generate.yml
    if: ${{ always() }}
    with:
      force: false
    needs: [pystats, pystats-tier2, nightly-default-blueberry,
        nightly-default-ripley, nightly-default-jones, nightly-default-prometheus,
        nightly-jit-blueberry, nightly-jit-ripley, nightly-jit-jones,
        nightly-jit-prometheus]
    secrets: inherit

  nightly-default-blueberry:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: linux-arm64-blueberry
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: false
      nogil: false
      tailcall: false
    secrets: inherit
  nightly-default-ripley:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: linux-x86_64-ripley
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: false
      nogil: false
      tailcall: false
    secrets: inherit
  nightly-default-jones:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: darwin-arm64-jones
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: false
      nogil: false
      tailcall: true
    secrets: inherit
  nightly-jit-blueberry:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: linux-arm64-blueberry
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: true
      nogil: false
      tailcall: false
    secrets: inherit
  nightly-jit-ripley:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: linux-x86_64-ripley
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: true
      nogil: false
      tailcall: false
    secrets: inherit
  nightly-jit-jones:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: darwin-arm64-jones
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: true
      nogil: false
      tailcall: true
    secrets: inherit
  nightly-default-prometheus:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: windows-x86_64-prometheus
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: false
      nogil: false
      tailcall: false
    secrets: inherit
  nightly-jit-prometheus:
    uses: ./.github/workflows/_benchmark.yml
    needs: determine_head
    with:
      fork: python
      ref: ${{ needs.determine_head.outputs.commit }}
      machine: windows-x86_64-prometheus
      benchmarks: all_and_excluded
      pgo: true
      tier2: false
      jit: true
      nogil: false
      tailcall: false
    secrets: inherit

  trigger-dashboard:
    runs-on: ubuntu-latest
    needs: [generate]
    if: ${{ always() && needs.generate.result == 'success' }}
    steps:
    - name: Trigger dashboard update
      run: |
        curl -X POST \
          -H "Accept: application/vnd.github.v3+json" \
          -H "Authorization: token ${{ secrets.DASHBOARD_REPO_PAT }}" \
          https://api.github.com/repos/savannahostrowski/doesjitgobrrr/dispatches \
          -d '{"event_type":"benchmark_completed"}'
